name: Build & Release APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'          # Ex: v1.2.0 → cria uma Release automática
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      # 1. Obter o código
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Configurar JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Cache do Gradle (acelera compilações futuras)
      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}
          restore-keys: gradle-

      # 4. Dar permissão de execução ao gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 5. Compilar APK Debug
      - name: Build Debug APK
        run: ./gradlew assembleDebug --no-daemon

      # 6. Guardar APK como artefacto (disponível em cada build)
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: smart-player-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    # Só corre quando é feito push de uma tag vX.Y.Z
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/libs.versions.toml') }}

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > app/smartplayer.jks

      - name: Build Release APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease --no-daemon

      # Renomear o APK com a versão da tag (ex: Smart_Player_v1.2.0.apk)
      - name: Rename APK
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          mv app/build/outputs/apk/release/app-release.apk \
             app/build/outputs/apk/release/Smart_Player_${VERSION}.apk
          echo "APK_NAME=Smart_Player_${VERSION}.apk" >> $GITHUB_ENV

      # Criar release no GitHub e annexar o APK
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Smart Player ${{ github.ref_name }}"
          body: |
            ## Smart Player ${{ github.ref_name }}
            
            ### Como instalar
            1. Descarrega o ficheiro `.apk` abaixo
            2. No telemóvel: **Definições → Segurança → Instalar apps desconhecidas**
            3. Abre o ficheiro e instala
            
            ### Novidades
            *(edita esta secção antes de publicar a tag)*
          files: app/build/outputs/apk/release/Smart_Player_${{ github.ref_name }}.apk
          draft: false
          prerelease: false
